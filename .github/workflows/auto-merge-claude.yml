name: Auto-merge Claude branches

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create and Merge PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -x  # Debug mode
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH"

          # Create PR if it doesn't exist
          if ! gh pr list --head "$BRANCH" --state open | grep -q .; then
            echo "Creating PR..."
            gh pr create --title "Auto: $BRANCH" --body "Auto PR" --base main --head "$BRANCH"
          fi

          # Get PR number
          sleep 2
          PR=$(gh pr list --head "$BRANCH" --state open --json number -q '.[0].number')
          echo "PR Number: $PR"

          # Merge PR
          if [ -n "$PR" ]; then
            echo "Merging PR #$PR..."
            gh pr merge "$PR" --squash --delete-branch || \
            gh pr merge "$PR" --merge --delete-branch || \
            gh pr merge "$PR" --squash || \
            gh pr merge "$PR" --merge || \
            echo "Could not merge - check branch protection"
          else
            echo "No PR found to merge"
          fi
