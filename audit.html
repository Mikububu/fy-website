<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Post Audit Tool</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        button {
            background: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 15px 40px;
            font-size: 18px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }
        button:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 20px #00ff00;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
        }
        .summary {
            background: #003300;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 30px;
        }
        .summary h2 {
            margin-top: 0;
            color: #00ff00;
        }
        .error-section {
            margin-bottom: 40px;
        }
        .error-section h3 {
            color: #ff0000;
            text-shadow: 0 0 10px #ff0000;
        }
        .post-error {
            background: #330000;
            border-left: 4px solid #ff0000;
            padding: 15px;
            margin: 10px 0;
        }
        .post-error h4 {
            margin: 0 0 10px 0;
            color: #ff6666;
        }
        .post-error ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .post-error li {
            color: #ff9999;
            margin: 5px 0;
        }
        .post-link {
            color: #00ffff;
            text-decoration: none;
        }
        .post-link:hover {
            text-decoration: underline;
        }
        .success {
            color: #00ff00;
        }
        .loading {
            text-align: center;
            font-size: 20px;
            margin: 20px 0;
        }
        .progress {
            background: #003300;
            border: 2px solid #00ff00;
            padding: 10px;
            margin: 20px 0;
        }
        .progress-bar {
            background: #00ff00;
            height: 30px;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>üîç BLOG POST AUDIT TOOL üîç</h1>

    <div class="controls">
        <button id="auditBtn" onclick="runAudit()">RUN FULL AUDIT</button>
        <button id="autoFixBtn" onclick="runAutoFix()" style="margin-left: 20px; background: #330000; border-color: #ff6600; color: #ff6600;">üîß AUTO-FIX ALL ISSUES</button>
    </div>

    <div id="progressContainer" style="display: none;">
        <div class="progress">
            <div id="progressText">Checking posts...</div>
            <div style="background: #001100; margin-top: 10px;">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div id="results" class="results"></div>

    <script>
        async function runAudit() {
            const btn = document.getElementById('auditBtn');
            const results = document.getElementById('results');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            btn.disabled = true;
            results.innerHTML = '';
            progressContainer.style.display = 'block';

            try {
                // Load blog-posts.json
                const blogPostsRes = await fetch('/blog-posts.json');
                const blogPosts = await blogPostsRes.json();

                const errors = {
                    missingThumbnail: [],
                    substackImages: [],
                    noText: [],
                    brokenLinks: [],
                    missingImages: []
                };

                let totalPosts = blogPosts.length;
                let processed = 0;

                for (const post of blogPosts) {
                    processed++;
                    const percent = Math.round((processed / totalPosts) * 100);
                    progressBar.style.width = percent + '%';
                    progressText.textContent = `Checking ${processed}/${totalPosts}: ${post.slug}`;

                    const postErrors = [];

                    // Check 1: Thumbnail exists and is not placeholder
                    try {
                        const thumbRes = await fetch(post.thumbnail, { method: 'HEAD' });
                        if (!thumbRes.ok) {
                            postErrors.push('‚ùå Thumbnail file not found: ' + post.thumbnail);
                            errors.missingThumbnail.push(post);
                        } else {
                            const size = thumbRes.headers.get('content-length');
                            if (size && parseInt(size) < 1000) {
                                postErrors.push('‚ùå Thumbnail too small (' + size + ' bytes) - likely placeholder');
                                errors.missingThumbnail.push(post);
                            }
                        }
                    } catch (e) {
                        postErrors.push('‚ùå Could not check thumbnail: ' + e.message);
                        errors.missingThumbnail.push(post);
                    }

                    // Check 2: Load post HTML and check for Substack images + UI
                    try {
                        const postRes = await fetch(post.link);
                        const html = await postRes.text();

                        // Check 2a: Verify og:image matches actual thumbnail (not fallback)
                        const ogImageMatch = html.match(/<meta property="og:image" content="([^"]+)"/);
                        if (ogImageMatch) {
                            const ogImage = ogImageMatch[1];
                            // Check if using fallback generic image instead of post thumbnail
                            if (ogImage.includes('Bali%20Tantra') || ogImage.includes('Bali Tantra')) {
                                postErrors.push('‚ùå og:image using generic fallback, not post thumbnail');
                                errors.missingThumbnail.push(post);
                            }
                        }

                        // Check 2b: Detect Substack UI not stripped
                        if (html.includes('class="pencraft') || html.includes('class="post-header')) {
                            postErrors.push('‚ùå Substack UI still present - not stripped!');
                            errors.substackImages.push(post);
                        }

                        // Check for Substack images
                        const substackMatches = html.match(/substackcdn\.com/g);
                        if (substackMatches && substackMatches.length > 0) {
                            postErrors.push(`‚ùå Contains ${substackMatches.length} Substack image(s) - not migrated`);
                            errors.substackImages.push(post);
                        }

                        // Check for Substack video player embeds (massive HTML blocks)
                        const substackVideoPlayer = html.match(/class="video-player-wrapper|class="container-dlhqPD|substackcdn\.com.*video/gi);
                        if (substackVideoPlayer && substackVideoPlayer.length > 0) {
                            postErrors.push(`‚ùå Contains Substack video player embed - post appears empty`);
                            errors.noText.push(post);
                        }

                        // Check for actual text content in post-content div only
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');

                        // Try to find the actual article content (not Substack UI)
                        const postContentDiv = doc.querySelector('.post-content');
                        let articleText = '';

                        if (postContentDiv) {
                            // Remove Substack embeds before counting text
                            const clone = postContentDiv.cloneNode(true);
                            const substackEmbeds = clone.querySelectorAll('[class*="container-dlhqPD"], [class*="video-wrapper"], [class*="video-player"]');
                            substackEmbeds.forEach(embed => embed.remove());

                            // Get remaining text
                            articleText = clone.innerText.replace(/\s+/g, ' ').trim();
                        } else {
                            articleText = doc.body.innerText.replace(/\s+/g, ' ').trim();
                        }

                        if (articleText.length < 200) {
                            postErrors.push(`‚ùå Very little article text content (${articleText.length} chars) - may be dominated by embeds`);
                            errors.noText.push(post);
                        }

                        // Check for local images
                        const localImages = html.match(/\/blog-images\//g);
                        if (!localImages || localImages.length === 0) {
                            postErrors.push('‚ùå No local blog-images found');
                            errors.missingImages.push(post);
                        }

                        // Check for broken image references (extension mismatches)
                        const imageRefs = html.match(/\/blog-images\/[^"'\s]+\.(jpg|jpeg|png|webp)/gi) || [];
                        for (const imgRef of imageRefs) {
                            try {
                                const imgPath = imgRef.replace(/^\//, '');
                                const checkRes = await fetch('/' + imgPath, { method: 'HEAD' });
                                if (!checkRes.ok) {
                                    postErrors.push('‚ùå Broken image reference: ' + imgRef);
                                    errors.missingImages.push(post);
                                }
                            } catch (e) {
                                // Skip, probably CORS issue
                            }
                        }

                    } catch (e) {
                        postErrors.push('‚ùå Could not load post HTML: ' + e.message);
                        errors.brokenLinks.push(post);
                    }

                    // Store errors for this post
                    if (postErrors.length > 0) {
                        post._errors = postErrors;
                    }
                }

                // Generate report
                progressContainer.style.display = 'none';
                displayResults(errors, blogPosts);

            } catch (e) {
                results.innerHTML = `<div class="post-error"><h4>‚ùå CRITICAL ERROR</h4><p>${e.message}</p></div>`;
            } finally {
                btn.disabled = false;
            }
        }

        function displayResults(errors, allPosts) {
            const results = document.getElementById('results');

            const totalErrors = errors.missingThumbnail.length +
                              errors.substackImages.length +
                              errors.noText.length +
                              errors.brokenLinks.length +
                              errors.missingImages.length;

            let html = `
                <div class="summary">
                    <h2>üìä AUDIT SUMMARY</h2>
                    <p><strong>Total Posts:</strong> ${allPosts.length}</p>
                    <p><strong>Posts with Issues:</strong> ${new Set([...errors.missingThumbnail, ...errors.substackImages, ...errors.noText, ...errors.brokenLinks, ...errors.missingImages].map(p => p.slug)).size}</p>
                    <p><strong>Total Errors Found:</strong> ${totalErrors}</p>
                    <hr>
                    <p>‚ùå Missing/Bad Thumbnails: ${errors.missingThumbnail.length}</p>
                    <p>‚ùå Substack Images Not Migrated: ${errors.substackImages.length}</p>
                    <p>‚ùå No Text Content: ${errors.noText.length}</p>
                    <p>‚ùå Broken Post Links: ${errors.brokenLinks.length}</p>
                    <p>‚ùå No Local Images: ${errors.missingImages.length}</p>
                </div>
            `;

            // Display posts with errors
            const postsWithErrors = allPosts.filter(p => p._errors);

            if (postsWithErrors.length > 0) {
                html += '<div class="error-section"><h3>‚ùå POSTS WITH ERRORS</h3>';

                postsWithErrors.forEach(post => {
                    html += `
                        <div class="post-error">
                            <h4><a href="${post.link}" class="post-link" target="_blank">${post.title}</a></h4>
                            <p><strong>Slug:</strong> ${post.slug}</p>
                            <p><strong>Thumbnail:</strong> ${post.thumbnail}</p>
                            <ul>
                                ${post._errors.map(err => `<li>${err}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });

                html += '</div>';
            } else {
                html += '<div class="success"><h2>‚úÖ ALL POSTS PASSED AUDIT!</h2></div>';
            }

            results.innerHTML = html;
        }

        async function runAutoFix() {
            const btn = document.getElementById('autoFixBtn');
            const auditBtn = document.getElementById('auditBtn');
            const results = document.getElementById('results');
            const progressContainer = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');

            // Disable buttons
            btn.disabled = true;
            auditBtn.disabled = true;
            progressContainer.style.display = 'block';
            progressText.textContent = 'üîß Running auto-fix script on server...';
            progressBar.style.width = '50%';

            results.innerHTML = `
                <div class="summary">
                    <h2>üîß AUTO-FIX IN PROGRESS</h2>
                    <p>Running comprehensive auto-fix script...</p>
                    <p style="margin-top: 20px;">This will:</p>
                    <ul>
                        <li>‚úì Strip Substack UI from all posts</li>
                        <li>‚úì Download missing Substack images (auto-downscaled)</li>
                        <li>‚úì Add local blog images</li>
                        <li>‚úì <strong>SEO Optimization:</strong> alt text, meta descriptions, og:image</li>
                        <li>‚úì <strong>Fix Broken Image References:</strong> corrects .png/.jpg extension mismatches</li>
                        <li>‚úì <strong>Intelligent Keyword Analysis:</strong> across ALL posts
                            <ul style="margin-top: 5px; font-size: 0.9em;">
                                <li>Finds keywords appearing 2+ times (Tanmatra, Chhayopasana, etc.)</li>
                                <li>Distinguishes smart keywords (Sanskrit, names, practices)</li>
                                <li>Filters out generic words (that, this, from, etc.)</li>
                                <li>Re-analyzes after fixes to catch new keywords</li>
                                <li>Updates meta tags with intelligent keywords only</li>
                            </ul>
                        </li>
                        <li>‚úì <strong>GIF Support:</strong> detects GIF images, downsizes, uses for thumbnails</li>
                        <li>‚úì Generate thumbnails (or use Michael's photo fallback)</li>
                        <li>‚úì Add top back links</li>
                        <li>‚úì Clean up all HTML</li>
                    </ul>
                    <p style="margin-top: 20px; color: #ff6600;">
                        <strong>‚ö†Ô∏è NOTE:</strong> Auto-fix runs on the server via Node.js.
                        You need to execute: <code>node auto-fix-posts.js</code>
                    </p>
                    <p style="margin-top: 10px;">
                        This audit page is browser-based and cannot execute server-side scripts.
                        Run the command in your terminal, then click "RUN FULL AUDIT" to verify fixes.
                    </p>
                </div>
            `;

            progressBar.style.width = '100%';
            progressText.textContent = '‚úì Instructions displayed';

            setTimeout(() => {
                btn.disabled = false;
                auditBtn.disabled = false;
                progressContainer.style.display = 'none';
            }, 2000);
        }
    </script>
</body>
</html>
