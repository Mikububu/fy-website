<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Post Audit Tool - Forbidden Yoga</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@100;400&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Bluu Next';
            src: url('Bluu Next/BluuNext-Bold.otf') format('opentype');
            font-weight: 700;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #f3f2de;
            color: #2c2c2c;
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .header {
            background: #B8D4D4;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        h1 {
            font-family: 'Bluu Next', 'Playfair Display', serif;
            font-size: 48px;
            color: #2c2c2c;
            margin: 0;
            font-weight: 700;
        }

        .subtitle {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            color: #5a5a5a;
            margin-top: 10px;
            font-weight: 100;
        }

        .controls {
            text-align: center;
            margin: 40px 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            background: #B8D4D4;
            color: #2c2c2c;
            border: 2px solid #2c2c2c;
            padding: 16px 48px;
            font-size: 16px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-weight: 400;
            transition: all 0.3s ease;
            border-radius: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: #2c2c2c;
            color: #f3f2de;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #2c2c2c;
            color: #f3f2de;
        }

        .btn-primary:hover {
            background: #B8D4D4;
            color: #2c2c2c;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .results {
            margin-top: 30px;
        }

        .summary {
            background: white;
            border: 3px solid #B8D4D4;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .summary h2 {
            font-family: 'Bluu Next', 'Playfair Display', serif;
            margin-top: 0;
            color: #2c2c2c;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .error-section {
            margin-bottom: 40px;
        }

        .error-section h3 {
            font-family: 'Bluu Next', 'Playfair Display', serif;
            color: #c45c4e;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .post-error {
            background: white;
            border-left: 5px solid #c45c4e;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .post-error h4 {
            margin: 0 0 12px 0;
            color: #2c2c2c;
            font-family: 'Roboto', sans-serif;
            font-weight: 400;
            font-size: 18px;
        }

        .post-error ul {
            margin: 12px 0;
            padding-left: 24px;
        }

        .post-error li {
            color: #5a5a5a;
            margin: 8px 0;
            line-height: 1.6;
        }

        .post-link {
            color: #6a9d9d;
            text-decoration: none;
            font-weight: 400;
        }

        .post-link:hover {
            text-decoration: underline;
            color: #2c2c2c;
        }

        .success {
            color: #6aa56a;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            margin: 30px 0;
            color: #5a5a5a;
        }

        .progress {
            background: white;
            border: 2px solid #B8D4D4;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .progress-bar {
            background: #B8D4D4;
            height: 30px;
            transition: width 0.3s;
            border-radius: 0;
        }

        .info-box {
            background: #B8D4D4;
            padding: 20px;
            margin: 30px 0;
            border-left: 5px solid #2c2c2c;
        }

        .info-box h3 {
            font-family: 'Bluu Next', 'Playfair Display', serif;
            margin-top: 0;
            font-size: 20px;
        }

        code {
            background: #e8e7d3;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Blog Post Audit Tool</h1>
        <div class="subtitle">Forbidden Yoga Content Management System</div>
    </div>

    <div class="container">
        <div class="controls">
            <button id="auditBtn" class="btn-primary" onclick="runAudit()">Run Full Audit</button>
            <button id="autoFixBtn" onclick="showFixInstructions()">Auto-Fix All Issues</button>
        </div>

        <div id="progressContainer" style="display: none;">
            <div class="progress">
                <div id="progressText">Checking posts...</div>
                <div style="background: #e8e7d3; margin-top: 15px;">
                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div id="results" class="results"></div>
    </div>

    <script>
        async function runAudit() {
            const btn = document.getElementById('auditBtn');
            const results = document.getElementById('results');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            btn.disabled = true;
            results.innerHTML = '';
            progressContainer.style.display = 'block';

            try {
                // Load blog-posts.json
                const blogPostsRes = await fetch('/blog-posts.json');
                const blogPosts = await blogPostsRes.json();

                const errors = {
                    missingThumbnail: [],
                    substackImages: [],
                    noText: [],
                    brokenLinks: [],
                    missingImages: []
                };

                let totalPosts = blogPosts.length;
                let processed = 0;

                for (const post of blogPosts) {
                    processed++;
                    const percent = Math.round((processed / totalPosts) * 100);
                    progressBar.style.width = percent + '%';
                    progressText.textContent = `Checking ${processed}/${totalPosts}: ${post.slug}`;

                    const postErrors = [];

                    // Check 1: Thumbnail exists and is not placeholder
                    try {
                        const thumbRes = await fetch(post.thumbnail, { method: 'HEAD' });
                        if (!thumbRes.ok) {
                            postErrors.push('‚ùå Thumbnail file not found: ' + post.thumbnail);
                            errors.missingThumbnail.push(post);
                        } else {
                            const size = thumbRes.headers.get('content-length');
                            if (size && parseInt(size) < 1000) {
                                postErrors.push('‚ùå Thumbnail too small (' + size + ' bytes) - likely placeholder');
                                errors.missingThumbnail.push(post);
                            }
                        }
                    } catch (e) {
                        postErrors.push('‚ùå Could not check thumbnail: ' + e.message);
                        errors.missingThumbnail.push(post);
                    }

                    // Check 2: Load post HTML and check for Substack images + UI
                    try {
                        const postRes = await fetch(post.link);
                        const html = await postRes.text();

                        // Check 2a: Verify og:image matches actual thumbnail (not fallback)
                        const ogImageMatch = html.match(/<meta property="og:image" content="([^"]+)"/);
                        if (ogImageMatch) {
                            const ogImage = ogImageMatch[1];
                            // Check if using fallback generic image instead of post thumbnail
                            if (ogImage.includes('Bali%20Tantra') || ogImage.includes('Bali Tantra')) {
                                postErrors.push('‚ùå og:image using generic fallback, not post thumbnail');
                                errors.missingThumbnail.push(post);
                            }
                        }

                        // Check 2b: Detect Substack UI not stripped
                        if (html.includes('class="pencraft') || html.includes('class="post-header')) {
                            postErrors.push('‚ùå Substack UI still present - not stripped!');
                            errors.substackImages.push(post);
                        }

                        // Check for Substack images
                        const substackMatches = html.match(/substackcdn\.com/g);
                        if (substackMatches && substackMatches.length > 0) {
                            postErrors.push(`‚ùå Contains ${substackMatches.length} Substack image(s) - not migrated`);
                            errors.substackImages.push(post);
                        }

                        // Check for Substack video player embeds (massive HTML blocks)
                        const substackVideoPlayer = html.match(/class="video-player-wrapper|class="container-dlhqPD|substackcdn\.com.*video/gi);
                        if (substackVideoPlayer && substackVideoPlayer.length > 0) {
                            postErrors.push(`‚ùå Contains Substack video player embed - post appears empty`);
                            errors.noText.push(post);
                        }

                        // Check for actual text content in post-content div only
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');

                        // Try to find the actual article content (not Substack UI)
                        const postContentDiv = doc.querySelector('.post-content');
                        let articleText = '';

                        if (postContentDiv) {
                            // Remove Substack embeds before counting text
                            const clone = postContentDiv.cloneNode(true);
                            const substackEmbeds = clone.querySelectorAll('[class*="container-dlhqPD"], [class*="video-wrapper"], [class*="video-player"]');
                            substackEmbeds.forEach(embed => embed.remove());

                            // Get remaining text
                            articleText = clone.innerText.replace(/\s+/g, ' ').trim();
                        } else {
                            articleText = doc.body.innerText.replace(/\s+/g, ' ').trim();
                        }

                        if (articleText.length < 200) {
                            postErrors.push(`‚ùå Very little article text content (${articleText.length} chars) - may be dominated by embeds`);
                            errors.noText.push(post);
                        }

                        // Check for local images
                        const localImages = html.match(/\/blog-images\//g);
                        if (!localImages || localImages.length === 0) {
                            postErrors.push('‚ùå No local blog-images found');
                            errors.missingImages.push(post);
                        }

                        // Check for broken image references (extension mismatches)
                        const imageRefs = html.match(/\/blog-images\/[^"'\s]+\.(jpg|jpeg|png|webp)/gi) || [];
                        for (const imgRef of imageRefs) {
                            try {
                                const imgPath = imgRef.replace(/^\//, '');
                                const checkRes = await fetch('/' + imgPath, { method: 'HEAD' });
                                if (!checkRes.ok) {
                                    postErrors.push('‚ùå Broken image reference: ' + imgRef);
                                    errors.missingImages.push(post);
                                }
                            } catch (e) {
                                // Skip, probably CORS issue
                            }
                        }

                    } catch (e) {
                        postErrors.push('‚ùå Could not load post HTML: ' + e.message);
                        errors.brokenLinks.push(post);
                    }

                    // Store errors for this post
                    if (postErrors.length > 0) {
                        post._errors = postErrors;
                    }
                }

                // Generate report
                progressContainer.style.display = 'none';
                displayResults(errors, blogPosts);

            } catch (e) {
                results.innerHTML = `<div class="post-error"><h4>‚ùå CRITICAL ERROR</h4><p>${e.message}</p></div>`;
            } finally {
                btn.disabled = false;
            }
        }

        function displayResults(errors, allPosts) {
            const results = document.getElementById('results');

            const totalErrors = errors.missingThumbnail.length +
                              errors.substackImages.length +
                              errors.noText.length +
                              errors.brokenLinks.length +
                              errors.missingImages.length;

            let html = `
                <div class="summary">
                    <h2>üìä AUDIT SUMMARY</h2>
                    <p><strong>Total Posts:</strong> ${allPosts.length}</p>
                    <p><strong>Posts with Issues:</strong> ${new Set([...errors.missingThumbnail, ...errors.substackImages, ...errors.noText, ...errors.brokenLinks, ...errors.missingImages].map(p => p.slug)).size}</p>
                    <p><strong>Total Errors Found:</strong> ${totalErrors}</p>
                    <hr>
                    <p>‚ùå Missing/Bad Thumbnails: ${errors.missingThumbnail.length}</p>
                    <p>‚ùå Substack Images Not Migrated: ${errors.substackImages.length}</p>
                    <p>‚ùå No Text Content: ${errors.noText.length}</p>
                    <p>‚ùå Broken Post Links: ${errors.brokenLinks.length}</p>
                    <p>‚ùå No Local Images: ${errors.missingImages.length}</p>
                </div>
            `;

            // Display posts with errors
            const postsWithErrors = allPosts.filter(p => p._errors);

            if (postsWithErrors.length > 0) {
                html += '<div class="error-section"><h3>‚ùå POSTS WITH ERRORS</h3>';

                postsWithErrors.forEach(post => {
                    html += `
                        <div class="post-error">
                            <h4><a href="${post.link}" class="post-link" target="_blank">${post.title}</a></h4>
                            <p><strong>Slug:</strong> ${post.slug}</p>
                            <p><strong>Thumbnail:</strong> ${post.thumbnail}</p>
                            <ul>
                                ${post._errors.map(err => `<li>${err}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });

                html += '</div>';
            } else {
                html += '<div class="success"><h2>‚úÖ ALL POSTS PASSED AUDIT!</h2></div>';
            }

            results.innerHTML = html;
        }

        function showFixInstructions() {
            const results = document.getElementById('results');

            results.innerHTML = `
                <div class="info-box">
                    <h3>Auto-Fix Instructions</h3>
                    <p style="margin: 15px 0;">The auto-fix system runs on the server via Node.js and must be executed from your terminal.</p>
                    <p style="margin: 15px 0;"><strong>Run this command:</strong></p>
                    <p style="margin: 15px 0; font-size: 20px;"><code>node auto-fix-posts.js</code></p>
                    <p style="margin: 15px 0;">After running the script, click "Run Full Audit" to verify all fixes were applied.</p>
                </div>
                <div class="summary">
                    <h2>What Auto-Fix Does</h2>
                    <p style="margin-bottom: 20px;">The comprehensive auto-fix script will:</p>
                    <ul style="line-height: 1.8;">
                        <li>‚úì Strip Substack UI from all posts</li>
                        <li>‚úì Download missing Substack images (auto-downscaled)</li>
                        <li>‚úì Add local blog images</li>
                        <li>‚úì <strong>SEO Optimization:</strong> alt text, meta descriptions, og:image</li>
                        <li>‚ö†Ô∏è <strong>Title/Slug Mismatch Detection:</strong> flags posts where title doesn't match filename
                            <ul style="margin-top: 8px; margin-bottom: 8px; font-size: 0.95em; color: #5a5a5a;">
                                <li>Normalizes titles to expected slug format</li>
                                <li>Calculates similarity score between actual and expected slug</li>
                                <li>Warns when similarity < 50% (likely wrong content or needs renaming)</li>
                                <li>Provides detailed mismatch summary at end of audit</li>
                            </ul>
                        </li>
                        <li>‚úì <strong>Fix Broken Image References:</strong> corrects .png/.jpg extension mismatches + detects tiny corrupted files</li>
                        <li>‚úì <strong>Semantic Keyword Intelligence:</strong> across ALL posts
                            <ul style="margin-top: 8px; margin-bottom: 8px; font-size: 0.95em; color: #5a5a5a;">
                                <li>üß† <strong>Semantic Relationship Analysis:</strong> Maps connections between tantric/yogic concepts</li>
                                <li>üîó <strong>Knowledge Graph:</strong> Understands relationships (e.g., Kali ‚Üí Shakti ‚Üí Kundalini)</li>
                                <li>üìä <strong>Semantic Scoring:</strong> Ranks keywords by richness of relationships</li>
                                <li>üåê <strong>Domain Clustering:</strong> Groups by Deities, Practices, Energy Systems, etc.</li>
                                <li>‚ö° <strong>Co-occurrence Analysis:</strong> Finds related terms that appear together</li>
                                <li>üéØ <strong>Smart Selection:</strong> Chooses semantically clustered keywords per post</li>
                                <li>Finds keywords appearing 2+ times</li>
                                <li>Filters out generic words</li>
                                <li>Updates meta tags with semantically intelligent keywords</li>
                            </ul>
                        </li>
                        <li>‚úì <strong>GIF Support:</strong> detects GIF images, downsizes, uses for thumbnails</li>
                        <li>‚úì Generate thumbnails (or use Michael's photo fallback)</li>
                        <li>‚úì Add top back links</li>
                        <li>‚úì Clean up all HTML</li>
                    </ul>
                </div>
            `;

            // Scroll to results
            results.scrollIntoView({ behavior: 'smooth' });
        }

        async function runAutoFix() {
            // This function is kept for backwards compatibility
            showFixInstructions();
        }
    </script>
</body>
</html>
